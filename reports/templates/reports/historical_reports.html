{% extends 'base.html' %}
{% block title %}Historical Reports{% endblock %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h2 class="text-2xl font-bold mb-4">Historical Reports</h2>
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white text-gray-900 shadow-md rounded-lg overflow-hidden">
            <thead class="bg-gray-100">
                <tr>
                    <th class="py-2 px-4 border-b-2 border-gray-200 text-left text-gray-700">Date of Report</th>
                    <th class="py-2 px-4 border-b-2 border-gray-200 text-left text-gray-700">Property Address</th>
                    <th class="py-2 px-4 border-b-2 border-gray-200 text-left text-gray-700">Survey time</th>
                    <!-- <th class="py-2 px-4 border-b-2 border-gray-200 text-left text-gray-700">Rooms Name</th> -->
                    <th class="py-2 px-4 border-b-2 border-gray-200 text-left text-gray-700">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for report in reports %}
                <tr class="hover:bg-gray-50">
                    <td class="py-2 px-4 border-b text-gray-900">{{ report.report_timestamp|date:"Y-m-d" }}</td>
                    <td class="py-2 px-4 border-b text-gray-900">{{ report.property_address }}</td>
                    <td class="py-2 px-4 border-b text-gray-900 flex flex-col flex-wrap gap-4">
                        <p>{{ report.start_time|date:"d M Y" }}</p><p>{{ report.end_time|date:"d M Y" }}</p>
                    </td>
                    <td class="py-2 px-4 border-b text-gray-900">
                        <!-- <p class="text-red-500">If this is red, Tailwind works.</p> -->
                        <!-- <p>Report Status: {{ report.status }}</p> -->
                        {% for payment in report.payments.all%}
                            <p>Payment ID: {{ payment.id }} Payment Status: {{payment.status}}</p>
                            {% if report.report_file and report.status == 'paid'%}
                                <a href="{% url 'download_report' report.id %}" class="text-white bg-blue-500 hover:underline">Download Report</a>
                            {% elif report.report_file and report.status == 'unpaid' or report.status == 'generated'%}
                                <div class="flex flex-col justify-center items-center gap-4 flex-wrap">
                                <button type ='button' id='pay-button-historical-reports' class="bg-blue-500 min-w-[110px] text-white px-4 py-2 rounded-md hover:bg-blue-700";
                                >Pay Now</button>
                                <button type ='button' data-report-id="{{ report.id }}" id='delete-report-button-historical-reports' class="delete-report-button bg-red-500 min-w-[110px] text-white px-4 py-2 rounded-md hover:bg-red-700";
                                >Delete Now </button>
                                <button type ='button' id='amend-report-button-historical-reports' class="bg-green-500 min-w-[110px] text-white px-4 py-2 rounded-md hover:bg-green-700";
                                >Amend</button>
                                </div>
                                <!-- <p>Status: {{ report.get_status_display }}</p>
                                <p>Price: {{ report.price }} {{ report.currency }}</p> -->
                            {% elif report.status == 'None'%}
                                <p>It seems report was generated previously. Contact us please.</p>
                                <!-- {{ report.status }} -->
                                <a href="{% url 'download_report' report.id %}" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-700">Download Report</a>  
                            {% else %}
                                <p>No report available.</p>
                            {% endif %}
                            {% empty%}
                            <p>It seems report was generated previously. Contact us please.</p>
                        {% endfor %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center py-4 text-gray-900">No reports found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>



<script>

const payButtonHR = document.querySelector('#pay-button-historical-reports');
payButtonHR.addEventListener('click', function () {
            console.log('btn clicked');
            });


</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Select all delete buttons
        const deleteButtons = document.querySelectorAll(".delete-report-button");
    
        deleteButtons.forEach(button => {
            button.addEventListener("click", function () {
                const reportId = this.getAttribute("data-report-id");
                const row = this.closest("tr"); // Get the parent table row
    
                if (confirm("Are you sure you want to delete this report?")) {
                    fetch(`/delete-report/${reportId}/`, {
                        method: "DELETE",
                        headers: {
                            "X-CSRFToken": getCookie("csrftoken"),  // CSRF protection
                            "Content-Type": "application/json"
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            row.remove(); // Remove the row from the table
                        } else {
                            alert("Failed to delete report.");
                        }
                    })
                    .catch(error => console.error("Error deleting report:", error));
                }
            });
        });
    
        // Function to get CSRF token for Django's security
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
    </script>
{% endblock %}